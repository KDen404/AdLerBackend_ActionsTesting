using System.Text;
using AdLerBackend.Application.World.ValidateATFFile;
using FluentAssertions;
using FluentValidation;
using MediatR;

namespace AdLerBackend.Application.UnitTests.World.ValidateAtfFile;

public class ValidateAtfFileTest
{
    private ValidateATFFileHandler _handler;

    [SetUp]
    public void Setup()
    {
        _handler = new ValidateATFFileHandler();
    }

    [Test]
    public async Task Handle_ValidJson_ReturnsUnit()
    {
        // Arrange
        var json =
            "{\"fileVersion\":\"0.3\",\"amgVersion\":\"0.3.2\",\"author\":\"\",\"language\":\"de\",\"world\":{\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"H5PTestWelt\"},\"worldName\":\"H5PTestWelt\",\"worldDescription\":\"\",\"worldGoals\":[\"\"],\"topics\":[],\"spaces\":[{\"spaceId\":1,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"Raum1\"},\"spaceName\":\"Raum1\",\"spaceDescription\":\"\",\"spaceGoals\":[\"\"],\"spaceContents\":[1,2,3,4,5,6,7,8,9,10],\"requiredPointsToComplete\":10,\"requiredSpacesToEnter\":\"\"},{\"spaceId\":2,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"Raum2\"},\"spaceName\":\"Raum2\",\"spaceDescription\":\"\",\"spaceGoals\":[\"\"],\"spaceContents\":[11,12,13,14,15,16,17,18,19,20],\"requiredPointsToComplete\":10,\"requiredSpacesToEnter\":\"\"},{\"spaceId\":3,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"Raum3\"},\"spaceName\":\"Raum3\",\"spaceDescription\":\"\",\"spaceGoals\":[\"\"],\"spaceContents\":[21,22,23,24,25,26,27,28,29,30],\"requiredPointsToComplete\":10,\"requiredSpacesToEnter\":\"\"},{\"spaceId\":4,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"Raum4\"},\"spaceName\":\"Raum4\",\"spaceDescription\":\"\",\"spaceGoals\":[\"\"],\"spaceContents\":[31,32,33,34,35,36,37,38,39,40],\"requiredPointsToComplete\":10,\"requiredSpacesToEnter\":\"\"},{\"spaceId\":5,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"Raum5\"},\"spaceName\":\"Raum5\",\"spaceDescription\":\"\",\"spaceGoals\":[\"\"],\"spaceContents\":[41,42,43,44,45,46,47,48,49],\"requiredPointsToComplete\":9,\"requiredSpacesToEnter\":\"\"}],\"elements\":[{\"elementId\":1,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"accordion\"},\"elementName\":\"accordion\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":2,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"advanced-blanks-example\"},\"elementName\":\"advanced-blanks-example\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":3,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"advent-blue-snowman\"},\"elementName\":\"advent-blue-snowman\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":4,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"agamotto\"},\"elementName\":\"agamotto\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":5,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"arithmetic-quiz\"},\"elementName\":\"arithmetic-quiz\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":6,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"audio-recorder\"},\"elementName\":\"audio-recorder\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":7,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"berries\"},\"elementName\":\"berries\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":8,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"chart\"},\"elementName\":\"chart\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":9,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"collage\"},\"elementName\":\"collage\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":10,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"contact-18\"},\"elementName\":\"contact-18\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":1},{\"elementId\":11,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"course-presentation\"},\"elementName\":\"course-presentation\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":12,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"dialog-cards\"},\"elementName\":\"dialog-cards\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":13,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"dictation\"},\"elementName\":\"dictation\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":14,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"docoumentation-tool\"},\"elementName\":\"docoumentation-tool\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":15,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"drag-and-drop\"},\"elementName\":\"drag-and-drop\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":16,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"drag-the-words\"},\"elementName\":\"drag-the-words\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":17,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"essay\"},\"elementName\":\"essay\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":18,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"example-content-crossword\"},\"elementName\":\"example-content-crossword\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":19,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"example-content-find-the-words\"},\"elementName\":\"example-content-find-the-words\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":20,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"example-content-image-choice\"},\"elementName\":\"example-content-image-choice\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":2},{\"elementId\":21,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"example-content-image-pairing\"},\"elementName\":\"example-content-image-pairing\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":22,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"example-content-sort-paragraphs\"},\"elementName\":\"example-content-sort-paragraphs\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":23,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"example-content-virtual-tour\"},\"elementName\":\"example-content-virtual-tour\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":24,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"fill-in-the-blanks\"},\"elementName\":\"fill-in-the-blanks\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":25,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"find-the-hotspot\"},\"elementName\":\"find-the-hotspot\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":26,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"flashcards\"},\"elementName\":\"flashcards\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":27,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"guess-the-answer\"},\"elementName\":\"guess-the-answer\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":28,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"h5p-column\"},\"elementName\":\"h5p-column\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":29,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"iframe-embedder\"},\"elementName\":\"iframe-embedder\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":30,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"image-hotspots\"},\"elementName\":\"image-hotspots\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":3},{\"elementId\":31,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"image-juxtaposition\"},\"elementName\":\"image-juxtaposition\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":32,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"image-multiple-hotspot-question\"},\"elementName\":\"image-multiple-hotspot-question\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":33,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"image-sequencing\"},\"elementName\":\"image-sequencing\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":34,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"image-slider\"},\"elementName\":\"image-slider\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":35,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"impressive-presentation\"},\"elementName\":\"impressive-presentation\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":36,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"interactive-video\"},\"elementName\":\"interactive-video\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":37,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"mark-the-words\"},\"elementName\":\"mark-the-words\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":38,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"memory-game\"},\"elementName\":\"memory-game\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":39,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"multiple-choice\"},\"elementName\":\"multiple-choice\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":40,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"personality-quiz\"},\"elementName\":\"personality-quiz\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":4},{\"elementId\":41,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"question-set\"},\"elementName\":\"question-set\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":42,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"questionnaire\"},\"elementName\":\"questionnaire\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":43,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"single-choice-set\"},\"elementName\":\"single-choice-set\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":44,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"skills-practice-a-home-visit\"},\"elementName\":\"skills-practice-a-home-visit\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":45,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"speak-the-words\"},\"elementName\":\"speak-the-words\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":46,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"speak-the-words-set-example\"},\"elementName\":\"speak-the-words-set-example\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":47,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"summary\"},\"elementName\":\"summary\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":48,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"timeline\"},\"elementName\":\"timeline\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5},{\"elementId\":49,\"lmsElementIdentifier\":{\"type\":\"moduleName\",\"value\":\"true-false-question\"},\"elementName\":\"true-false-question\",\"url\":\"\",\"elementDescription\":\"\",\"elementGoals\":[\"\"],\"elementCategory\":\"h5p\",\"elementFileType\":\"h5p\",\"elementMaxScore\":1,\"learningSpaceParentId\":5}]}}";
        using var stream = new MemoryStream(Encoding.UTF8.GetBytes(json));

        var command = new ValidateATFFileCommand
        {
            ATFFileStream = stream
        };

        // Act
        var result = await _handler.Handle(command, CancellationToken.None);

        // Assert
        result.Should().Be(Unit.Value);
    }

    [Test]
    public void Handle_InvalidJson_ThrowsValidationException()
    {
        // Arrange
        var invalidJson = @"{ ""foo"": ""bar"" }{""baz"":""qux""}";
        using var stream = new MemoryStream(Encoding.UTF8.GetBytes(invalidJson));

        var command = new ValidateATFFileCommand
        {
            ATFFileStream = stream
        };

        // Act & Assert
        Assert.ThrowsAsync<ValidationException>(async () => await _handler.Handle(command, CancellationToken.None));
    }
}